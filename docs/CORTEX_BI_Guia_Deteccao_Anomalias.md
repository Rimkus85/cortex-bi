# üîç C√ìRTEX BI - Guia Completo de Detec√ß√£o Proativa de Anomalias

**Vers√£o:** 2.0  
**Data:** Outubro 2025  
**Desenvolvido em parceria com:** Manus AI

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Como Funciona](#como-funciona)
3. [Configura√ß√£o Inicial](#configura√ß√£o-inicial)
4. [Treinamento do Modelo](#treinamento-do-modelo)
5. [Ativa√ß√£o da Detec√ß√£o Proativa](#ativa√ß√£o-da-detec√ß√£o-proativa)
6. [Configura√ß√£o de Alertas](#configura√ß√£o-de-alertas)
7. [Monitoramento Cont√≠nuo](#monitoramento-cont√≠nuo)
8. [Casos de Uso Pr√°ticos](#casos-de-uso-pr√°ticos)
9. [Ajuste Fino e Otimiza√ß√£o](#ajuste-fino-e-otimiza√ß√£o)
10. [Troubleshooting](#troubleshooting)

---

## üéØ Vis√£o Geral

O sistema de **Detec√ß√£o Proativa de Anomalias** do C√ìRTEX BI utiliza algoritmos de Machine Learning (especificamente **Isolation Forest**) para identificar automaticamente padr√µes anormais em seus dados de neg√≥cio.

### O que o sistema detecta:

‚úÖ **Quedas s√∫bitas em m√©tricas** - Ex: vendas ca√≠ram 15% sem motivo aparente  
‚úÖ **Picos inesperados** - Ex: aumento anormal de custos  
‚úÖ **Padr√µes at√≠picos** - Ex: comportamento de compra incomum  
‚úÖ **Desvios de tend√™ncia** - Ex: KPI fora da faixa hist√≥rica esperada  
‚úÖ **Outliers em dados** - Ex: valores extremos que fogem do padr√£o  

### Benef√≠cios:

üöÄ **Detec√ß√£o autom√°tica** - N√£o precisa monitorar manualmente  
‚ö° **Alertas em tempo real** - Notifica√ß√£o imediata quando anomalia √© detectada  
üéØ **Redu√ß√£o de riscos** - Identifica problemas antes que se tornem cr√≠ticos  
üìä **Insights acion√°veis** - Recomenda√ß√µes de a√ß√µes corretivas  
üîÑ **Aprendizado cont√≠nuo** - Sistema melhora com o tempo  

---

## üîß Como Funciona

### Arquitetura do Sistema

O sistema de detec√ß√£o de anomalias √© composto por tr√™s componentes principais:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    C√ìRTEX BI                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  ML Engine   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Anomaly    ‚îÇ‚îÄ‚îÄ‚ñ∂‚îÇ  Alert    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ    ‚îÇ   Detector   ‚îÇ   ‚îÇ  System   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                  ‚îÇ      ‚îÇ
‚îÇ         ‚ñº                    ‚ñº                  ‚ñº      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ  Training    ‚îÇ    ‚îÇ  Real-time   ‚îÇ   ‚îÇ  Notifi-  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ  Data        ‚îÇ    ‚îÇ  Monitoring  ‚îÇ   ‚îÇ  cation   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Algoritmo Isolation Forest

O C√ìRTEX BI utiliza o algoritmo **Isolation Forest**, que funciona assim:

1. **Treinamento**: Aprende o comportamento "normal" dos seus dados hist√≥ricos
2. **Isolamento**: Identifica pontos que s√£o facilmente "isolados" (an√¥malos)
3. **Score**: Atribui um score de anomalia (-1 = an√¥malo, 1 = normal)
4. **Threshold**: Define limiar de sensibilidade para alertas

**Vantagens do Isolation Forest:**
- ‚úÖ N√£o requer dados rotulados (unsupervised learning)
- ‚úÖ Eficiente com grandes volumes de dados
- ‚úÖ Detecta anomalias multidimensionais
- ‚úÖ Baixo custo computacional

---

## ‚öôÔ∏è Configura√ß√£o Inicial

### Passo 1: Verificar Pr√©-requisitos

Certifique-se de que o C√ìRTEX BI est√° instalado e rodando:

```bash
# Verificar status do sistema
curl http://localhost:5000/health

# Resposta esperada deve incluir:
{
  "services": {
    "ml_engine": "active",
    ...
  }
}
```

### Passo 2: Configurar Vari√°veis de Ambiente

Edite o arquivo `.env` na raiz do projeto:

```bash
# ===== MACHINE LEARNING =====
ML_ENABLED=True
ML_MODEL_PATH=data/models/

# ===== DETEC√á√ÉO DE ANOMALIAS =====
ANOMALY_DETECTION_ENABLED=True
ANOMALY_CONTAMINATION=0.1        # 10% dos dados s√£o considerados potenciais anomalias
ANOMALY_THRESHOLD=-0.5           # Score abaixo deste valor √© considerado anomalia
ANOMALY_MIN_SAMPLES=20           # M√≠nimo de amostras para treinar o modelo
ANOMALY_RETRAIN_INTERVAL=86400   # Retreinar a cada 24 horas (em segundos)

# ===== MONITORAMENTO PROATIVO =====
PROACTIVE_MONITORING_ENABLED=True
MONITORING_INTERVAL=300          # Verificar a cada 5 minutos (em segundos)
MONITORING_METRICS=vendas,custos,receita,lucro  # M√©tricas para monitorar

# ===== ALERTAS =====
ALERT_ENABLED=True
ALERT_CHANNELS=email,teams,webhook  # Canais de notifica√ß√£o
ALERT_SEVERITY_THRESHOLD=medium     # low, medium, high, critical

# ===== EMAIL (para alertas) =====
ALERT_EMAIL_TO=gerente@empresa.com,diretor@empresa.com
ALERT_EMAIL_FROM=cortexbi-alerts@empresa.com
SMTP_HOST=smtp.office365.com
SMTP_PORT=587
SMTP_USER=cortexbi@empresa.com
SMTP_PASSWORD=sua-senha

# ===== MICROSOFT TEAMS (para alertas) =====
TEAMS_WEBHOOK_URL=https://outlook.office.com/webhook/seu-webhook-url

# ===== WEBHOOK CUSTOMIZADO =====
CUSTOM_WEBHOOK_URL=https://seu-sistema.com/api/alerts
CUSTOM_WEBHOOK_AUTH_TOKEN=seu-token-de-autenticacao
```

### Passo 3: Criar Estrutura de Diret√≥rios

```bash
# Criar diret√≥rios necess√°rios
mkdir -p data/models
mkdir -p data/anomalies
mkdir -p logs/anomalies
mkdir -p config/anomaly_rules

# Configurar permiss√µes
chmod 755 data/models data/anomalies logs/anomalies config/anomaly_rules
```

### Passo 4: Reiniciar o Sistema

```bash
# Parar o servidor
./scripts/stop_ai.sh  # Linux/macOS
# ou
.\scripts\stop_ai.bat  # Windows

# Iniciar o servidor
./scripts/start_ai.sh  # Linux/macOS
# ou
.\scripts\start_ai.bat  # Windows
```

---

## üéì Treinamento do Modelo

### M√©todo 1: Treinamento Autom√°tico via API

O m√©todo mais simples √© usar a API para treinar o modelo:

```bash
# Treinar o detector de anomalias
curl -X POST "http://localhost:5000/ml/train/anomaly_detector" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: sua-api-key" \
  -d '{
    "retrain": true,
    "contamination": 0.1
  }'
```

**Resposta esperada:**

```json
{
  "status": "success",
  "model": "anomaly_detector",
  "metrics": {
    "anomaly_rate": 0.095,
    "training_samples": 1250,
    "features": 5,
    "trained_at": "2025-10-14T18:30:00.000000"
  },
  "message": "Modelo treinado com sucesso"
}
```

### M√©todo 2: Treinamento via Python Script

Crie um script personalizado para treinar o modelo:

```python
# train_anomaly_detector.py

from src.agents.ml_engine import MLEngine
import json

# Inicializar ML Engine
ml_engine = MLEngine(models_dir="data/models")

# Treinar detector de anomalias
print("Iniciando treinamento do detector de anomalias...")
metrics = ml_engine.train_anomaly_detector(retrain=True)

print("\nResultados do treinamento:")
print(json.dumps(metrics, indent=2))

if "error" not in metrics:
    print("\n‚úÖ Modelo treinado com sucesso!")
    print(f"üìä Amostras de treinamento: {metrics['training_samples']}")
    print(f"üéØ Taxa de anomalia: {metrics['anomaly_rate']:.2%}")
else:
    print(f"\n‚ùå Erro no treinamento: {metrics['error']}")
```

Execute o script:

```bash
python train_anomaly_detector.py
```

### M√©todo 3: Treinamento Agendado (Autom√°tico)

Configure o treinamento autom√°tico peri√≥dico:

**Linux/macOS (usando cron):**

```bash
# Editar crontab
crontab -e

# Adicionar linha para retreinar diariamente √†s 2h da manh√£
0 2 * * * cd /caminho/para/cortex-bi && python train_anomaly_detector.py >> logs/training.log 2>&1
```

**Windows (usando Task Scheduler):**

```powershell
# Criar tarefa agendada
$action = New-ScheduledTaskAction -Execute "python" -Argument "C:\caminho\para\cortex-bi\train_anomaly_detector.py"
$trigger = New-ScheduledTaskTrigger -Daily -At 2am
Register-ScheduledTask -Action $action -Trigger $trigger -TaskName "CORTEX_BI_Train_Anomaly" -Description "Retreinar detector de anomalias diariamente"
```

### Verificar Status do Modelo

```bash
# Verificar se o modelo foi treinado
curl -X GET "http://localhost:5000/ml/models/status" \
  -H "X-API-Key: sua-api-key"
```

**Resposta:**

```json
{
  "models": {
    "anomaly_detector": {
      "trained": true,
      "last_training": "2025-10-14T02:00:00.000000",
      "samples": 1250,
      "accuracy": 0.95
    }
  }
}
```

---

## üöÄ Ativa√ß√£o da Detec√ß√£o Proativa

### Configurar M√©tricas para Monitoramento

Crie um arquivo de configura√ß√£o para definir quais m√©tricas monitorar:

```bash
# Criar arquivo de configura√ß√£o
nano config/anomaly_rules/metrics_config.json
```

**Conte√∫do do arquivo:**

```json
{
  "metrics": [
    {
      "name": "vendas_totais",
      "data_source": "sql_server",
      "query": "SELECT SUM(valor_venda) as total FROM vendas WHERE data = CAST(GETDATE() AS DATE)",
      "threshold_type": "percentage",
      "threshold_value": 15,
      "severity": "high",
      "check_interval": 300,
      "enabled": true
    },
    {
      "name": "custos_operacionais",
      "data_source": "csv",
      "file_path": "data/custos_diarios.csv",
      "column": "custo_total",
      "threshold_type": "absolute",
      "threshold_value": 50000,
      "severity": "medium",
      "check_interval": 600,
      "enabled": true
    },
    {
      "name": "taxa_conversao",
      "data_source": "api",
      "api_endpoint": "https://api.empresa.com/metrics/conversao",
      "threshold_type": "percentage",
      "threshold_value": 10,
      "severity": "high",
      "check_interval": 300,
      "enabled": true
    },
    {
      "name": "tempo_resposta_sistema",
      "data_source": "internal",
      "metric_key": "avg_response_time",
      "threshold_type": "absolute",
      "threshold_value": 5000,
      "severity": "critical",
      "check_interval": 60,
      "enabled": true
    }
  ],
  "global_settings": {
    "min_historical_days": 30,
    "confidence_threshold": 0.8,
    "alert_cooldown": 3600
  }
}
```

### Iniciar Monitoramento Proativo

**M√©todo 1: Via API**

```bash
# Iniciar monitoramento
curl -X POST "http://localhost:5000/anomaly/monitoring/start" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: sua-api-key" \
  -d '{
    "config_file": "config/anomaly_rules/metrics_config.json",
    "interval": 300
  }'
```

**M√©todo 2: Via Script Python**

Crie um script de monitoramento cont√≠nuo:

```python
# start_proactive_monitoring.py

import time
import requests
import json
from datetime import datetime
from src.agents.ml_engine import MLEngine
from src.agents.analytics_engine import AnalyticsEngine

class ProactiveAnomalyMonitor:
    def __init__(self, config_file: str):
        self.ml_engine = MLEngine()
        self.analytics_engine = AnalyticsEngine()
        
        # Carregar configura√ß√£o
        with open(config_file, 'r') as f:
            self.config = json.load(f)
        
        self.metrics = self.config['metrics']
        self.global_settings = self.config['global_settings']
        
        print(f"‚úÖ Monitor inicializado com {len(self.metrics)} m√©tricas")
    
    def check_metric(self, metric_config: dict):
        """Verifica uma m√©trica espec√≠fica"""
        try:
            # Obter valor atual da m√©trica
            current_value = self._get_metric_value(metric_config)
            
            # Obter hist√≥rico
            historical_data = self._get_historical_data(metric_config)
            
            # Detectar anomalia usando ML Engine
            result = self.ml_engine.detect_anomaly({
                "metric_name": metric_config['name'],
                "current_value": current_value,
                "historical_data": historical_data,
                "execution_time": 0,
                "request_data": json.dumps(metric_config),
                "response_data": json.dumps({"value": current_value}),
                "user_id": "system"
            })
            
            if result.get("is_anomaly"):
                self._trigger_alert(metric_config, current_value, result)
            
            return result
            
        except Exception as e:
            print(f"‚ùå Erro ao verificar m√©trica {metric_config['name']}: {e}")
            return {"error": str(e)}
    
    def _get_metric_value(self, metric_config: dict):
        """Obt√©m valor atual da m√©trica"""
        data_source = metric_config['data_source']
        
        if data_source == "sql_server":
            # Executar query SQL
            from src.agents.data_loader import DataLoader
            loader = DataLoader()
            result = loader.query_sql_server(metric_config['query'])
            return result[0]['total'] if result else 0
            
        elif data_source == "csv":
            # Ler arquivo CSV
            import pandas as pd
            df = pd.read_csv(metric_config['file_path'])
            return df[metric_config['column']].iloc[-1]
            
        elif data_source == "api":
            # Chamar API externa
            response = requests.get(metric_config['api_endpoint'])
            return response.json().get('value', 0)
            
        elif data_source == "internal":
            # M√©trica interna do sistema
            return self._get_internal_metric(metric_config['metric_key'])
        
        return 0
    
    def _get_historical_data(self, metric_config: dict, days: int = 30):
        """Obt√©m dados hist√≥ricos da m√©trica"""
        # Implementar l√≥gica para obter hist√≥rico
        # Por enquanto, retorna lista vazia
        return []
    
    def _get_internal_metric(self, metric_key: str):
        """Obt√©m m√©trica interna do sistema"""
        # Implementar l√≥gica para m√©tricas internas
        return 0
    
    def _trigger_alert(self, metric_config: dict, current_value: float, anomaly_result: dict):
        """Dispara alerta de anomalia"""
        alert_data = {
            "timestamp": datetime.now().isoformat(),
            "metric_name": metric_config['name'],
            "current_value": current_value,
            "severity": metric_config['severity'],
            "anomaly_score": anomaly_result.get('anomaly_score'),
            "confidence": anomaly_result.get('confidence'),
            "message": f"Anomalia detectada em {metric_config['name']}: valor atual {current_value}"
        }
        
        print(f"\nüö® ALERTA DE ANOMALIA:")
        print(json.dumps(alert_data, indent=2))
        
        # Enviar alertas
        self._send_email_alert(alert_data)
        self._send_teams_alert(alert_data)
        self._send_webhook_alert(alert_data)
    
    def _send_email_alert(self, alert_data: dict):
        """Envia alerta por email"""
        # Implementar envio de email
        pass
    
    def _send_teams_alert(self, alert_data: dict):
        """Envia alerta para Microsoft Teams"""
        # Implementar envio para Teams
        pass
    
    def _send_webhook_alert(self, alert_data: dict):
        """Envia alerta para webhook customizado"""
        # Implementar envio para webhook
        pass
    
    def run(self):
        """Executa monitoramento cont√≠nuo"""
        print("\nüöÄ Iniciando monitoramento proativo de anomalias...")
        print(f"üìä Monitorando {len(self.metrics)} m√©tricas")
        
        while True:
            for metric in self.metrics:
                if not metric.get('enabled', True):
                    continue
                
                print(f"\nüîç Verificando: {metric['name']}")
                result = self.check_metric(metric)
                
                if result.get("is_anomaly"):
                    print(f"‚ö†Ô∏è  Anomalia detectada!")
                else:
                    print(f"‚úÖ Normal")
                
                # Aguardar intervalo espec√≠fico da m√©trica
                time.sleep(metric.get('check_interval', 300))

# Executar monitor
if __name__ == "__main__":
    monitor = ProactiveAnomalyMonitor("config/anomaly_rules/metrics_config.json")
    monitor.run()
```

Execute o script:

```bash
# Executar em background
nohup python start_proactive_monitoring.py > logs/anomalies/monitor.log 2>&1 &

# Ver logs em tempo real
tail -f logs/anomalies/monitor.log
```

---

## üìß Configura√ß√£o de Alertas

### Alertas por Email

Configure o envio de emails no arquivo `.env`:

```bash
ALERT_EMAIL_ENABLED=True
ALERT_EMAIL_TO=gerente@empresa.com,diretor@empresa.com
ALERT_EMAIL_CC=ti@empresa.com
ALERT_EMAIL_FROM=cortexbi-alerts@empresa.com
ALERT_EMAIL_SUBJECT_PREFIX=[C√ìRTEX BI - ALERTA]

SMTP_HOST=smtp.office365.com
SMTP_PORT=587
SMTP_USE_TLS=True
SMTP_USER=cortexbi@empresa.com
SMTP_PASSWORD=sua-senha
```

**Template de email personalizado:**

Crie um arquivo `config/anomaly_rules/email_template.html`:

```html
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        .alert-box { 
            border: 2px solid #dc3545; 
            padding: 20px; 
            margin: 20px 0;
            background-color: #f8d7da;
        }
        .severity-high { border-color: #dc3545; background-color: #f8d7da; }
        .severity-medium { border-color: #ffc107; background-color: #fff3cd; }
        .severity-low { border-color: #17a2b8; background-color: #d1ecf1; }
        .metric-value { font-size: 24px; font-weight: bold; color: #dc3545; }
    </style>
</head>
<body>
    <h2>üö® Alerta de Anomalia Detectada</h2>
    
    <div class="alert-box severity-{{severity}}">
        <h3>{{metric_name}}</h3>
        <p><strong>Valor Atual:</strong> <span class="metric-value">{{current_value}}</span></p>
        <p><strong>Severidade:</strong> {{severity}}</p>
        <p><strong>Confian√ßa:</strong> {{confidence}}%</p>
        <p><strong>Data/Hora:</strong> {{timestamp}}</p>
    </div>
    
    <h3>üìä Detalhes da Anomalia</h3>
    <ul>
        <li><strong>Score de Anomalia:</strong> {{anomaly_score}}</li>
        <li><strong>Desvio do Padr√£o:</strong> {{deviation}}%</li>
        <li><strong>Valor Esperado:</strong> {{expected_value}}</li>
    </ul>
    
    <h3>üí° Recomenda√ß√µes</h3>
    <ul>
        {{#each recommendations}}
        <li>{{this}}</li>
        {{/each}}
    </ul>
    
    <hr>
    <p><small>Este √© um alerta autom√°tico do C√ìRTEX BI. Para mais informa√ß√µes, acesse o dashboard administrativo.</small></p>
</body>
</html>
```

### Alertas no Microsoft Teams

Configure o webhook do Teams:

```bash
# No arquivo .env
ALERT_TEAMS_ENABLED=True
TEAMS_WEBHOOK_URL=https://outlook.office.com/webhook/seu-webhook-url
```

**Criar webhook no Teams:**

1. Abra o canal do Teams onde deseja receber alertas
2. Clique nos tr√™s pontos (‚ãØ) ‚Üí "Connectors"
3. Procure por "Incoming Webhook" e clique em "Configure"
4. D√™ um nome (ex: "C√ìRTEX BI Alertas") e clique em "Create"
5. Copie a URL do webhook gerada
6. Cole no arquivo `.env`

**Template de mensagem Teams:**

```json
{
  "@type": "MessageCard",
  "@context": "https://schema.org/extensions",
  "summary": "Anomalia Detectada",
  "themeColor": "dc3545",
  "title": "üö® C√ìRTEX BI - Alerta de Anomalia",
  "sections": [
    {
      "activityTitle": "{{metric_name}}",
      "activitySubtitle": "Severidade: {{severity}}",
      "facts": [
        {
          "name": "Valor Atual:",
          "value": "{{current_value}}"
        },
        {
          "name": "Confian√ßa:",
          "value": "{{confidence}}%"
        },
        {
          "name": "Data/Hora:",
          "value": "{{timestamp}}"
        }
      ]
    }
  ],
  "potentialAction": [
    {
      "@type": "OpenUri",
      "name": "Ver Dashboard",
      "targets": [
        {
          "os": "default",
          "uri": "http://localhost:5000/admin/admin_dashboard.html"
        }
      ]
    }
  ]
}
```

### Alertas via Webhook Customizado

Para integrar com sistemas pr√≥prios:

```bash
# No arquivo .env
ALERT_WEBHOOK_ENABLED=True
CUSTOM_WEBHOOK_URL=https://seu-sistema.com/api/alerts
CUSTOM_WEBHOOK_METHOD=POST
CUSTOM_WEBHOOK_AUTH_TYPE=bearer  # ou 'basic', 'api_key'
CUSTOM_WEBHOOK_AUTH_TOKEN=seu-token
```

**Payload enviado:**

```json
{
  "source": "cortex_bi",
  "alert_type": "anomaly_detection",
  "timestamp": "2025-10-14T18:30:00.000000",
  "severity": "high",
  "metric": {
    "name": "vendas_totais",
    "current_value": 85000,
    "expected_value": 100000,
    "deviation_percentage": -15
  },
  "anomaly": {
    "score": -0.75,
    "confidence": 0.92,
    "is_anomaly": true
  },
  "recommendations": [
    "Verificar campanhas de marketing ativas",
    "Analisar concorr√™ncia",
    "Revisar estrat√©gia de pre√ßos"
  ]
}
```

---

## üìä Monitoramento Cont√≠nuo

### Dashboard de Anomalias

Acesse o dashboard espec√≠fico de anomalias:

```
http://localhost:5000/admin/anomalies_dashboard.html
```

**Funcionalidades do Dashboard:**

- üìà Gr√°fico de anomalias detectadas ao longo do tempo
- üéØ M√©tricas mais afetadas
- üìä Distribui√ß√£o de severidade
- üîî Hist√≥rico de alertas
- ‚öôÔ∏è Configura√ß√£o de regras
- üì• Exportar relat√≥rios

### API de Monitoramento

**Listar anomalias detectadas:**

```bash
curl -X GET "http://localhost:5000/anomaly/list?days=7" \
  -H "X-API-Key: sua-api-key"
```

**Verificar m√©trica espec√≠fica:**

```bash
curl -X POST "http://localhost:5000/anomaly/check" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: sua-api-key" \
  -d '{
    "metric_name": "vendas_totais",
    "current_value": 85000,
    "historical_data": [100000, 98000, 102000, 99000, 101000]
  }'
```

**Status do monitoramento:**

```bash
curl -X GET "http://localhost:5000/anomaly/monitoring/status" \
  -H "X-API-Key: sua-api-key"
```

---

## üíº Casos de Uso Pr√°ticos

### Caso 1: Monitorar Vendas Di√°rias

**Objetivo:** Detectar quedas inesperadas nas vendas

**Configura√ß√£o:**

```json
{
  "name": "vendas_diarias",
  "data_source": "sql_server",
  "query": "SELECT SUM(valor_venda) as total FROM vendas WHERE data = CAST(GETDATE() AS DATE)",
  "threshold_type": "percentage",
  "threshold_value": 10,
  "severity": "high",
  "check_interval": 3600,
  "enabled": true,
  "alert_channels": ["email", "teams"],
  "recipients": ["gerente.vendas@empresa.com"]
}
```

**Resultado:**
- Sistema verifica vendas a cada hora
- Se vendas ca√≠rem mais de 10%, dispara alerta
- Gerente de vendas recebe email e notifica√ß√£o no Teams

### Caso 2: Monitorar Custos Operacionais

**Objetivo:** Identificar picos anormais de custos

**Configura√ß√£o:**

```json
{
  "name": "custos_operacionais",
  "data_source": "csv",
  "file_path": "data/custos_diarios.csv",
  "column": "custo_total",
  "threshold_type": "absolute",
  "threshold_value": 50000,
  "severity": "medium",
  "check_interval": 7200,
  "enabled": true,
  "alert_channels": ["email"],
  "recipients": ["controller@empresa.com"]
}
```

**Resultado:**
- Sistema verifica custos a cada 2 horas
- Se custos ultrapassarem R$ 50.000, dispara alerta
- Controller recebe email com detalhes

### Caso 3: Monitorar Performance do Sistema

**Objetivo:** Detectar degrada√ß√£o de performance

**Configura√ß√£o:**

```json
{
  "name": "tempo_resposta_api",
  "data_source": "internal",
  "metric_key": "avg_response_time",
  "threshold_type": "absolute",
  "threshold_value": 5000,
  "severity": "critical",
  "check_interval": 60,
  "enabled": true,
  "alert_channels": ["teams", "webhook"],
  "recipients": ["ti@empresa.com"]
}
```

**Resultado:**
- Sistema verifica performance a cada minuto
- Se tempo de resposta > 5 segundos, dispara alerta cr√≠tico
- TI recebe notifica√ß√£o imediata no Teams

---

## üéõÔ∏è Ajuste Fino e Otimiza√ß√£o

### Ajustar Sensibilidade

A sensibilidade do detector pode ser ajustada atrav√©s do par√¢metro `contamination`:

```python
# Mais sens√≠vel (detecta mais anomalias)
contamination = 0.05  # 5% dos dados s√£o anomalias

# Sensibilidade padr√£o
contamination = 0.1   # 10% dos dados s√£o anomalias

# Menos sens√≠vel (detecta apenas anomalias muito evidentes)
contamination = 0.2   # 20% dos dados s√£o anomalias
```

**Via API:**

```bash
curl -X POST "http://localhost:5000/ml/train/anomaly_detector" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: sua-api-key" \
  -d '{
    "retrain": true,
    "contamination": 0.05
  }'
```

### Ajustar Threshold de Alerta

```bash
# No arquivo .env
ANOMALY_THRESHOLD=-0.5   # Padr√£o
ANOMALY_THRESHOLD=-0.3   # Mais sens√≠vel (mais alertas)
ANOMALY_THRESHOLD=-0.7   # Menos sens√≠vel (menos alertas)
```

### Filtrar Falsos Positivos

Crie regras para ignorar falsos positivos conhecidos:

```json
{
  "false_positive_rules": [
    {
      "metric_name": "vendas_totais",
      "condition": "day_of_week == 0",
      "reason": "Domingos sempre t√™m vendas baixas"
    },
    {
      "metric_name": "acessos_sistema",
      "condition": "hour >= 22 or hour <= 6",
      "reason": "Baixo acesso durante madrugada √© normal"
    }
  ]
}
```

### Retreinamento Autom√°tico

Configure retreinamento peri√≥dico para manter o modelo atualizado:

```bash
# No arquivo .env
ANOMALY_AUTO_RETRAIN=True
ANOMALY_RETRAIN_INTERVAL=86400      # 24 horas
ANOMALY_RETRAIN_MIN_NEW_SAMPLES=100  # M√≠nimo de novas amostras para retreinar
```

---

## üîç Troubleshooting

### Problema: Modelo n√£o detecta anomalias √≥bvias

**Poss√≠veis causas:**
- Threshold muito alto
- Contamination muito alta
- Dados de treinamento insuficientes

**Solu√ß√µes:**

```bash
# 1. Ajustar threshold
ANOMALY_THRESHOLD=-0.3  # Mais sens√≠vel

# 2. Ajustar contamination
curl -X POST "http://localhost:5000/ml/train/anomaly_detector" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: sua-api-key" \
  -d '{"retrain": true, "contamination": 0.05}'

# 3. Verificar quantidade de dados de treinamento
curl -X GET "http://localhost:5000/ml/models/status" \
  -H "X-API-Key: sua-api-key"
```

### Problema: Muitos falsos positivos

**Poss√≠veis causas:**
- Threshold muito baixo
- Contamination muito baixa
- Dados de treinamento n√£o representativos

**Solu√ß√µes:**

```bash
# 1. Ajustar threshold
ANOMALY_THRESHOLD=-0.7  # Menos sens√≠vel

# 2. Ajustar contamination
curl -X POST "http://localhost:5000/ml/train/anomaly_detector" \
  -H "Content-Type: application/json" \
  -H "X-API-Key: sua-api-key" \
  -d '{"retrain": true, "contamination": 0.15}'

# 3. Adicionar regras de falsos positivos
# Editar config/anomaly_rules/false_positive_rules.json
```

### Problema: Alertas n√£o est√£o sendo enviados

**Verifica√ß√µes:**

```bash
# 1. Verificar se alertas est√£o habilitados
grep ALERT_ENABLED .env

# 2. Verificar logs de alertas
tail -f logs/anomalies/alerts.log

# 3. Testar envio de email
curl -X POST "http://localhost:5000/admin/test/email" \
  -H "X-API-Key: sua-api-key"

# 4. Testar webhook do Teams
curl -X POST "http://localhost:5000/admin/test/teams" \
  -H "X-API-Key: sua-api-key"
```

### Problema: Alto uso de CPU/mem√≥ria

**Solu√ß√µes:**

```bash
# 1. Aumentar intervalo de verifica√ß√£o
MONITORING_INTERVAL=600  # 10 minutos em vez de 5

# 2. Reduzir n√∫mero de m√©tricas monitoradas
# Editar config/anomaly_rules/metrics_config.json
# Desabilitar m√©tricas menos cr√≠ticas

# 3. Limitar hist√≥rico de dados
ANOMALY_HISTORICAL_DAYS=30  # Em vez de 90
```

---

## üìû Suporte e Recursos

### Documenta√ß√£o Adicional

- **README Principal**: `/docs/README.md`
- **API Reference**: `http://localhost:5000/docs`
- **Guia de Instala√ß√£o**: `/docs/guia_instalacao.md`

### Scripts √öteis

- `train_anomaly_detector.py` - Treinar modelo
- `start_proactive_monitoring.py` - Iniciar monitoramento
- `test_anomaly_detection.py` - Testar detec√ß√£o
- `export_anomalies_report.py` - Exportar relat√≥rio

### Contato

- **GitHub Issues**: https://github.com/Rimkus85/cortex-bi/issues
- **Email**: suporte@cortexbi.com

---

**C√ìRTEX BI v2.0** - *Cognitive Operations & Real-Time EXpert Business Intelligence*  
Desenvolvido em parceria com **Manus AI** | Outubro 2025

üö® **Detec√ß√£o Proativa de Anomalias**  
Identifique problemas antes que se tornem cr√≠ticos!

